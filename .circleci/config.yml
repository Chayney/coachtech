version: 2.1

jobs:
  build:
    docker:
      - image: php:7.4.9-fpm
    working_directory: /home/circleci/project
    steps:
      - checkout
      - run:
          name: Install Docker Compose
          command: |
            curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
      - run:
          name: Start Docker Compose services
          command: |
            docker-compose up -d  # バックグラウンドでサービスを立ち上げる
      - run:
          name: Install Composer
          command: |
            docker-compose exec app bash -c "curl -sS https://getcomposer.org/installer | php"
            docker-compose exec app bash -c "mv composer.phar /usr/local/bin/composer"
      - run:
          name: Install Laravel dependencies
          command: |
            docker-compose exec app bash -c "composer install"
      - run:
          name: Install NPM dependencies
          command: |
            docker-compose exec app bash -c "npm install"
      - run:
          name: Run NPM build
          command: |
            docker-compose exec app bash -c "npm run prod"
      - run:
          name: Copy .env.example to .env
          command: |
            docker-compose exec app bash -c "cp .env.example .env"
      - run:
          name: Generate Laravel app key
          command: |
            docker-compose exec app bash -c "php artisan key:generate"
      - run:
          name: Run migrations and tests
          command: |
            docker-compose exec app bash -c "php artisan migrate --env=testing --force"
            docker-compose exec app bash -c "php artisan test"

  deploy:
    docker:
      - image: google/cloud-sdk
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.7
      - run:
          name: Authenticate Docker to gcr.io
          command: |
            echo $GCLOUD_SERVICE_KEY | base64 --decode --ignore-garbage > ${HOME}/gcloud-service-key.json
            gcloud auth activate-service-account --key-file=${HOME}/gcloud-service-key.json
            gcloud --quiet config set project $GOOGLE_PROJECT_ID
            gcloud auth configure-docker
      - run:
          name: Build Docker image for deployment
          command: |
            docker build -t gcr.io/$GOOGLE_PROJECT_ID/coachtech:$CIRCLE_SHA1 .
      - run:
          name: Push Docker image to Google Container Registry
          command: docker push gcr.io/$GOOGLE_PROJECT_ID/coachtech:$CIRCLE_SHA1
      - run:
          name: Deploy to Cloud Run
          command: |
            gcloud run deploy coachtech --image gcr.io/$GOOGLE_PROJECT_ID/coachtech:$CIRCLE_SHA1 --region us-central1 --platform managed --quiet

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build